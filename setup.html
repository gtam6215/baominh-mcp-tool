<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Bao Minh Setup Final</title>
    <style>
        body { font-family: sans-serif; background: #111; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .box { background: #1f1f1f; padding: 30px; border-radius: 15px; width: 400px; border: 1px solid #333; }
        input, select { width: 100%; padding: 12px; margin: 5px 0 15px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; box-sizing: border-box; }
        button { background: #0f0; width: 100%; padding: 15px; font-weight: bold; cursor: pointer; border: none; border-radius: 8px; font-size: 15px; }
        button:hover { background: #00cc00; }
        #log { margin-top: 15px; background: #000; padding: 10px; border-radius: 5px; display: none; font-size: 13px; line-height: 1.5; }
        .success { color: #0f0; }
        .info { color: #3498db; }
        .error { color: #ff4444; }
    </style>
</head>
<body>
    <div class="box">
        <h2 style="color:#0f0; text-align:center">C·∫§U H√åNH THI·∫æT B·ªä</h2>
        
        <label style="font-size:12px; color:#aaa">Token Xiaozhi (Link wss:// c≈©ng ƒë∆∞·ª£c):</label>
        <input type="text" id="token" placeholder="D√°n Token v√†o ƒë√¢y...">
        
        <label style="font-size:12px; color:#aaa">T√™n Thi·∫øt B·ªã:</label>
        <input type="text" id="name" placeholder="V√≠ d·ª•: CongTac">
        
        <label style="font-size:12px; color:#aaa">Khu V·ª±c:</label>
        <select id="room">
            <option value="PhongKhach">Ph√≤ng Kh√°ch</option>
            <option value="PhongNgu">Ph√≤ng Ng·ªß</option>
            <option value="Bep">B·∫øp</option>
            <option value="SanVuon">S√¢n V∆∞·ªùn</option>
        </select>
        
        <button id="btn" onclick="run()">CH·ªåN C·ªîNG USB & ƒê·ªíNG B·ªò</button>
        <div id="log"></div>
    </div>

    <script>
        function log(m, type="info") { 
            const el = document.getElementById('log');
            el.style.display = 'block';
            el.innerHTML += `<div class="${type}">${m}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        function extractToken(input) {
            input = input.trim();
            if (input.includes("token=")) return input.split("token=")[1];
            return input;
        }

        async function run() {
            document.getElementById('log').innerHTML = "";
            const btn = document.getElementById('btn');
            
            let rawInput = document.getElementById('token').value;
            const token = extractToken(rawInput);
            const n = document.getElementById('name').value.trim() || "ThietBi";
            const r = document.getElementById('room').value;

            if(!token) return alert("Vui l√≤ng nh·∫≠p Token!");

            let port;
            try {
                // 1. CH·ªåN C·ªîNG USB
                port = await navigator.serial.requestPort();
                
                // 2. M·ªû C·ªîNG NGAY (QUAN TR·ªåNG: ƒê·ªÉ gi·ªØ k·∫øt n·ªëi kh√¥ng b·ªã m·∫•t)
                await port.open({baudRate: 115200});
                log("‚úÖ ƒê√£ k·∫øt n·ªëi USB th√†nh c√¥ng.", "success");
                
                btn.disabled = true; // Kh√≥a n√∫t ƒë·ªÉ tr√°nh b·∫•m nhi·ªÅu l·∫ßn
            } catch (e) {
                return log("‚ùå L·ªói m·ªü c·ªïng USB: " + e.message + "<br>(H√£y ƒë√≥ng tab c≈© ho·∫∑c r√∫t c√°p c·∫Øm l·∫°i)", "error");
            }

            try {
                // 3. K·∫æT N·ªêI CLOUD
                log("‚è≥ ƒêang ƒëƒÉng k√Ω Cloud Xiaozhi...", "info");
                await regCloud(token, n, r);
                log("‚úÖ ƒêƒÉng k√Ω Cloud xong!", "success");

                // 4. GHI V√ÄO CHIP
                log("‚è≥ ƒêang ghi d·ªØ li·ªáu xu·ªëng Chip...", "info");
                const writer = port.writable.getWriter();
                await writer.write(new TextEncoder().encode(`SET_CONFIG:${token},${n},${r}\n`));
                writer.releaseLock();
                
                log("üéâ TH√ÄNH C√îNG! Thi·∫øt b·ªã ƒëang kh·ªüi ƒë·ªông l·∫°i.", "success");
                alert("C√†i ƒë·∫∑t ho√†n t·∫•t!");
                
            } catch(e) { 
                log("‚ùå L·ªói: " + e.message, "error"); 
            } finally {
                // Lu√¥n ƒë√≥ng c·ªïng d√π th√†nh c√¥ng hay th·∫•t b·∫°i
                if (port) await port.close();
                btn.disabled = false;
            }
        }

        function regCloud(t, d, r) {
            return new Promise((resolve, reject) => {
                const ws = new WebSocket(`wss://api.xiaozhi.me/mcp/?token=${t}`);
                let isDone = false;

                ws.onopen = () => { console.log("Socket open"); };
                
                ws.onmessage = (e) => {
                    try {
                        const j = JSON.parse(e.data);
                        if(j.method=="initialize") {
                            ws.send(JSON.stringify({
                                jsonrpc:"2.0", id:j.id,
                                result:{protocolVersion:"2024-11-05", serverInfo:{name:`[${r}] ${d}`, version:"1.0"}}
                            }));
                        }
                        if(j.method=="tools/list") {
                            ws.send(JSON.stringify({
                                jsonrpc:"2.0", id:j.id,
                                result:{tools:[{name:"control_relay", description:`Dieu khien tai ${r}`, inputSchema:{type:"object", properties:{id:{type:"integer"}, on:{type:"boolean"}}}}] }
                            }));
                            isDone = true;
                            setTimeout(()=>{ ws.close(); resolve(); }, 500);
                        }
                    } catch(err) {}
                };
                
                ws.onerror = () => { if(!isDone) reject(new Error("Token kh√¥ng ƒë√∫ng ho·∫∑c l·ªói m·∫°ng")); };
                setTimeout(()=> { if(!isDone) reject(new Error("Timeout: Server kh√¥ng ph·∫£n h·ªìi")); }, 8000);
            });
        }
    </script>
</body>
</html>
