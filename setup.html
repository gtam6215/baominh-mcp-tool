<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Bao Minh Setup DEBUG</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 20px; }
        .box { border: 1px solid #333; padding: 20px; max-width: 600px; margin: auto; }
        input, select { width: 100%; padding: 10px; margin: 5px 0 15px; background: #222; border: 1px solid #444; color: white; }
        button { background: #0f0; color: #000; width: 100%; padding: 15px; font-weight: bold; cursor: pointer; border: none; font-size: 16px; }
        #log { margin-top: 20px; border-top: 1px dashed #444; padding-top: 10px; color: #fff; font-size: 13px; white-space: pre-wrap; }
        .err { color: #ff4444; font-weight: bold; }
        .ok { color: #0f0; }
        .info { color: #3498db; }
    </style>
</head>
<body>
    <div class="box">
        <h2 style="text-align:center; color:#0f0">C√îNG C·ª§ C·∫§U H√åNH (CH·∫æ ƒê·ªò DEBUG)</h2>
        
        <label>Token:</label>
        <input type="text" id="token" placeholder="D√°n Token...">
        
        <label>T√™n Thi·∫øt B·ªã:</label>
        <input type="text" id="name" value="TestDevice">
        
        <label>Khu V·ª±c:</label>
        <select id="room">
            <option value="PhongKhach">Ph√≤ng Kh√°ch</option>
        </select>
        
        <button id="btn" onclick="runDebug()">B·∫ÆT ƒê·∫¶U ƒê·ªíNG B·ªò</button>
        
        <div id="log">Logs s·∫Ω hi·ªán ·ªü ƒë√¢y...</div>
    </div>

    <script>
        function log(msg, type="info") {
            const el = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }

        async function runDebug() {
            document.getElementById('log').innerHTML = ""; // X√≥a log c≈©
            const btn = document.getElementById('btn');
            
            // 1. L·∫•y d·ªØ li·ªáu
            let rawInput = document.getElementById('token').value.trim();
            if (!rawInput) return log("‚ùå Ch∆∞a nh·∫≠p Token!", "err");
            
            let token = rawInput;
            if (rawInput.includes("token=")) token = rawInput.split("token=")[1];
            
            const name = document.getElementById('name').value;
            const room = document.getElementById('room').value;

            log("üöÄ B·∫Øt ƒë·∫ßu quy tr√¨nh...", "info");
            log(`- Token: ${token.substring(0, 10)}...`);
            log(`- Thi·∫øt b·ªã: ${name} @ ${room}`);

            let port;
            try {
                // 2. Ch·ªçn c·ªïng
                log("üëâ Vui l√≤ng ch·ªçn c·ªïng USB trong c·ª≠a s·ªï hi·ªán ra...", "info");
                port = await navigator.serial.requestPort();
                log("‚úÖ ƒê√£ ch·ªçn c·ªïng USB.", "ok");

                // 3. M·ªü c·ªïng ngay
                log("‚ö° ƒêang m·ªü c·ªïng USB (open)...", "info");
                await port.open({ baudRate: 115200 });
                log("‚úÖ C·ªïng USB ƒë√£ m·ªü th√†nh c√¥ng.", "ok");
                
                // Ki·ªÉm tra quy·ªÅn ghi
                if (!port.writable) throw new Error("C·ªïng USB kh√¥ng cho ph√©p ghi (port.writable = null)");
                log("- Tr·∫°ng th√°i c·ªïng: S·∫µn s√†ng ghi.", "info");

                btn.disabled = true;

                // 4. ƒêƒÉng k√Ω Cloud
                log("‚òÅÔ∏è ƒêang k·∫øt n·ªëi Cloud Xiaozhi (c√≥ th·ªÉ m·∫•t v√†i gi√¢y)...", "info");
                await regCloud(token, name, room);
                log("‚úÖ ƒêƒÉng k√Ω Cloud HO√ÄN T·∫§T.", "ok");

                // 5. Ghi d·ªØ li·ªáu (Ph·∫ßn hay l·ªói nh·∫•t)
                log("üîå Chu·∫©n b·ªã ghi v√†o chip...", "info");
                
                log("- ƒêang t·∫°o Writer...", "info");
                const writer = port.writable.getWriter();
                log("‚úÖ ƒê√£ t·∫°o Writer.", "ok");

                const dataStr = `SET_CONFIG:${token},${name},${room}\n`;
                log(`- ƒêang m√£ h√≥a d·ªØ li·ªáu (${dataStr.length} bytes)...`, "info");
                const dataEncoded = new TextEncoder().encode(dataStr);

                log("üöÄ ƒêANG G·ª¨I D·ªÆ LI·ªÜU (WRITE)...", "info");
                await writer.write(dataEncoded);
                log("‚úÖ GHI TH√ÄNH C√îNG (WRITE DONE).", "ok");

                log("- ƒêang nh·∫£ kh√≥a (releaseLock)...", "info");
                writer.releaseLock();
                
                log("üîí ƒêang ƒë√≥ng c·ªïng USB...", "info");
                await port.close();
                log("‚úÖ ƒê√£ ƒë√≥ng c·ªïng.", "ok");

                log("üéâüéâ T·∫§T C·∫¢ ƒê√É XONG! THI·∫æT B·ªä S·∫º KH·ªûI ƒê·ªòNG L·∫†I.", "ok");
                alert("Th√†nh c√¥ng!");

            } catch (e) {
                log(`‚ùå L·ªñI NGHI√äM TR·ªåNG: ${e.message}`, "err");
                log("‚ö†Ô∏è G·ª£i √Ω: H√£y r√∫t c√°p USB ra, c·∫Øm l·∫°i v√† t·∫£i l·∫°i trang web (F5).", "err");
            } finally {
                btn.disabled = false;
            }
        }

        function regCloud(t, d, r) {
            return new Promise((resolve, reject) => {
                log("- ƒêang m·ªü WebSocket...", "info");
                const ws = new WebSocket(`wss://api.xiaozhi.me/mcp/?token=${t}`);
                let isDone = false;

                ws.onopen = () => log("- WebSocket ƒë√£ k·∫øt n·ªëi.", "ok");
                
                ws.onmessage = (e) => {
                    try {
                        const j = JSON.parse(e.data);
                        log(`- Nh·∫≠n tin t·ª´ Server: ${j.method}`, "info");
                        
                        if(j.method=="initialize") {
                            log("  -> G·ª≠i ph·∫£n h·ªìi Initialize...", "info");
                            ws.send(JSON.stringify({
                                jsonrpc:"2.0", id:j.id,
                                result:{protocolVersion:"2024-11-05", serverInfo:{name:`[${r}] ${d}`, version:"1.0"}}
                            }));
                        }
                        if(j.method=="tools/list") {
                            log("  -> G·ª≠i danh s√°ch Tools...", "info");
                            ws.send(JSON.stringify({
                                jsonrpc:"2.0", id:j.id,
                                result:{tools:[{name:"control_relay", description:`Dieu khien tai ${r}`, inputSchema:{type:"object", properties:{id:{type:"integer"}, on:{type:"boolean"}}}}] }
                            }));
                            isDone = true;
                            // ƒê√≥ng nhanh ƒë·ªÉ chuy·ªÉn sang b∆∞·ªõc ghi
                            setTimeout(()=>{ 
                                ws.close(); 
                                resolve(); 
                            }, 500);
                        }
                    } catch(err) { log("! L·ªói parse JSON", "err"); }
                };
                
                ws.onerror = () => { 
                    if(!isDone) reject(new Error("Token sai ho·∫∑c l·ªói m·∫°ng kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c Xiaozhi")); 
                };
                
                setTimeout(()=> { 
                    if(!isDone) reject(new Error("Timeout: Server Xiaozhi kh√¥ng ph·∫£n h·ªìi sau 8s")); 
                }, 8000);
            });
        }
    </script>
</body>
</html>
