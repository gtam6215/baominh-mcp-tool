<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Cấu Hình Sản Xuất V7.5</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .box { background: #1e1e1e; padding: 40px; border-radius: 12px; width: 100%; max-width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); border: 1px solid #333; }
        h2 { color: #00e676; margin-top: 0; text-align: center; }
        label { font-size: 13px; color: #aaa; margin-top: 15px; display: block; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; }
        input:focus { border-color: #00e676; outline: none; }
        button { background: #00e676; color: #000; width: 100%; padding: 15px; font-weight: bold; cursor: pointer; border: none; border-radius: 8px; font-size: 16px; margin-top: 25px; transition: 0.3s; }
        button:hover { background: #00c853; }
        #log { margin-top: 20px; font-family: monospace; font-size: 12px; color: #888; white-space: pre-wrap; height: 100px; overflow-y: auto; background: #111; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="box">
        <h2>CẤU HÌNH THIẾT BỊ</h2>
        
        <label>Token Xiaozhi:</label>
        <input type="text" id="token" placeholder="Nhập Token (ey...)">
        
        <div style="display: flex; gap: 10px;">
            <div style="flex:1">
                <label>Tên Gốc (VD: Đèn):</label>
                <input type="text" id="name" value="Đèn">
            </div>
            <div style="flex:1">
                <label>Vị Trí (Phòng):</label>
                <input type="text" id="room" value="Phòng Khách">
            </div>
        </div>

        <label>Số Kênh:</label>
        <select id="ch">
            <option value="1">1 Kênh</option>
            <option value="2">2 Kênh</option>
            <option value="4" selected>4 Kênh</option>
            <option value="8">8 Kênh</option>
        </select>

        <button onclick="startConfig()" id="btn">KẾT NỐI USB & CẤU HÌNH</button>
        <div id="log"></div>
    </div>

    <script>
        function log(msg, color="#ccc") {
            const d = document.getElementById('log');
            d.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
        }

        async function startConfig() {
            const token = document.getElementById('token').value.trim();
            const name = document.getElementById('name').value.trim();
            const room = document.getElementById('room').value.trim();
            const ch = document.getElementById('ch').value;
            const btn = document.getElementById('btn');

            if (!token) return alert("Vui lòng nhập Token!");
            if (!navigator.serial) return alert("Trình duyệt không hỗ trợ Web Serial API. Hãy dùng Chrome/Edge.");

            try {
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 }); // Phải khớp với firmware
                log("Đã kết nối cổng COM.", "#00e676");
                btn.disabled = true;

                // Gửi lệnh
                const writer = port.writable.getWriter();
                const cmd = `SET_CONFIG:${token},${name},${room},${ch}\n`;
                log("Đang gửi lệnh...", "#fff");
                await writer.write(new TextEncoder().encode(cmd));
                writer.releaseLock();

                // Đọc phản hồi
                const reader = port.readable.getReader();
                const decoder = new TextDecoder();
                let buffer = "";
                let done = false;
                
                // Timeout an toàn
                const timeout = setTimeout(() => {
                    log("⚠️ Không nhận được phản hồi từ chip!", "orange");
                    if (!done) { reader.cancel(); done = true; btn.disabled = false; }
                }, 5000);

                while (!done) {
                    const { value, done: readerDone } = await reader.read();
                    if (readerDone) break;
                    buffer += decoder.decode(value);
                    
                    if (buffer.includes("CONF_OK")) {
                        clearTimeout(timeout);
                        log("✅ CẤU HÌNH THÀNH CÔNG!", "#00ff00");
                        alert("Thành công! Thiết bị đang khởi động lại.");
                        done = true;
                        reader.cancel();
                    }
                }
                
                reader.releaseLock();
                await port.close();

            } catch (err) {
                log("Lỗi: " + err, "red");
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
