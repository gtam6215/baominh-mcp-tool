<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£o Minh Setup Pro V4.1</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a0a; color: #fff; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .box { background: #1a1a1a; padding: 30px; border-radius: 12px; width: 100%; max-width: 450px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { color: #00e676; text-align: center; margin-top: 0; }
        label { font-size: 13px; color: #aaa; margin-top: 15px; display: block; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; margin-top: 25px; }
        button { flex: 1; padding: 15px; font-weight: bold; cursor: pointer; border: none; border-radius: 8px; transition: 0.2s; }
        .btn-save { background: #00e676; color: #000; }
        .btn-reset { background: #e74c3c; color: #fff; }
        .btn-test { background: #3498db; color: #fff; }
        #log { margin-top: 20px; font-family: monospace; font-size: 12px; color: #888; white-space: pre-wrap; height: 120px; overflow-y: auto; background: #111; padding: 10px; border-radius: 5px; border: 1px solid #333; }
    </style>
</head>
<body>

<div class="box">
    <h2>B·∫¢O MINH SETUP PRO</h2>
    <div style="text-align:center; color:#555; font-size:11px; margin-bottom:15px;">V4.1 - Physical Feedback</div>

    <label>Token Xiaozhi:</label>
    <input type="text" id="token" placeholder="D√°n m√£ Token (ey...)">
    
    <div style="display: flex; gap: 10px;">
        <div style="flex:1">
            <label>T√™n G·ªëc:</label>
            <input type="text" id="name" value="ƒê√®n">
        </div>
        <div style="flex:1">
            <label>V·ªã Tr√≠:</label>
            <input type="text" id="room" value="Ph√≤ng Kh√°ch">
        </div>
    </div>

    <label>S·ªë K√™nh:</label>
    <select id="ch">
        <option value="1">1 K√™nh</option>
        <option value="2">2 K√™nh</option>
        <option value="4" selected>4 K√™nh</option>
        <option value="8">8 K√™nh</option>
    </select>

    <button onclick="sendTest()" class="btn-test" style="margin-top:15px; width:100%">üîä TEST K·∫æT N·ªêI (K√äU T·∫†CH)</button>

    <div class="btn-group">
        <button class="btn-reset" onclick="sendReset()" id="btnReset">üßπ FORMAT</button>
        <button class="btn-save" onclick="sendConfig()" id="btnSave">üíæ C·∫§U H√åNH</button>
    </div>
    
    <div id="log">Ch∆∞a k·∫øt n·ªëi USB...</div>
</div>

<script>
    let port;
    let writer;
    
    function log(msg, color="#ccc") {
        const d = document.getElementById('log');
        d.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
        d.scrollTop = d.scrollHeight;
    }

    async function connect() {
        if (!port) {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                writer = port.writable.getWriter();
                log("ƒê√£ k·∫øt n·ªëi USB.", "#00e676");
                // ƒê·ªçc ph·∫£n h·ªìi
                readLoop();
                return true;
            } catch (err) {
                log("L·ªói k·∫øt n·ªëi: " + err, "red");
                return false;
            }
        }
        return true;
    }

    async function readLoop() {
        const reader = port.readable.getReader();
        const decoder = new TextDecoder();
        try {
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const text = decoder.decode(value);
                if (text.includes("CONF_OK")) {
                    log("‚úÖ TH√ÄNH C√îNG! (Chip ƒë√£ l∆∞u)", "#00ff00");
                    alert("C·∫•u h√¨nh th√†nh c√¥ng! Nghe ti·∫øng t·∫°ch d√†i l√† OK.");
                }
                if (text.includes("TEST_OK")) {
                    log("‚úÖ K·∫æT N·ªêI T·ªêT! (ƒê√£ nghe ti·∫øng t·∫°ch)", "#3498db");
                }
                if (text.includes("RESET_OK")) {
                    log("‚úÖ ƒê√É FORMAT XONG!", "orange");
                    alert("ƒê√£ x√≥a s·∫°ch chip. Gi·ªù h√£y n·∫°p c·∫•u h√¨nh.");
                }
                // log("Chip: " + text); // Debug raw
            }
        } catch (error) {
            console.error(error);
        } finally {
            reader.releaseLock();
        }
    }

    async function sendTest() {
        if (!await connect()) return;
        log("G·ª≠i l·ªánh Test...", "#fff");
        await writer.write(new TextEncoder().encode("CMD:TEST\n"));
    }

    async function sendReset() {
        if (!await connect()) return;
        if (!confirm("X√≥a s·∫°ch chip?")) return;
        log("G·ª≠i l·ªánh Format...", "orange");
        await writer.write(new TextEncoder().encode("CMD:RESET\n"));
    }

    async function sendConfig() {
        const token = document.getElementById('token').value.trim();
        const name = document.getElementById('name').value.trim();
        const room = document.getElementById('room').value.trim();
        const ch = document.getElementById('ch').value;

        if (!token) return alert("Thi·∫øu Token!");
        if (!await connect()) return;

        const cmd = `SET_CONFIG:${token},${name},${room},${ch}\n`;
        log("ƒêang g·ª≠i c·∫•u h√¨nh...", "#fff");
        await writer.write(new TextEncoder().encode(cmd));
    }
</script>
</body>
</html>
