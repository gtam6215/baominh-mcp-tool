<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£o Minh Factory Tool V4.3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --border-color: #30363d;
            --primary-color: #238636; /* Xanh GitHub */
            --primary-hover: #2ea043;
            --danger-color: #da3633;
            --info-color: #1f6feb;
            --text-main: #c9d1d9;
            --text-muted: #8b949e;
            --accent: #58a6ff;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh;
        }
        
        /* Layout ch√≠nh */
        .container { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 24px; 
            width: 100%; 
            max-width: 1100px; 
        }

        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
        }

        /* Card Style */
        .card { 
            background: var(--card-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            padding: 24px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Header */
        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .version-badge {
            font-size: 0.75rem;
            background: var(--border-color);
            padding: 2px 8px;
            border-radius: 12px;
            color: var(--text-muted);
        }

        /* Form Elements */
        .form-group { margin-bottom: 4px; }
        label { 
            font-size: 0.85rem; 
            color: var(--text-muted); 
            margin-bottom: 6px; 
            display: block; 
            font-weight: 600;
        }
        input, select { 
            width: 100%; 
            padding: 12px; 
            background: #0d1117; 
            border: 1px solid var(--border-color); 
            color: #fff; 
            border-radius: 6px; 
            box-sizing: border-box; 
            font-family: 'Inter', sans-serif;
            transition: border-color 0.2s;
        }
        input:focus, select:focus { 
            border-color: var(--accent); 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
        }

        /* Grid cho Input nh·ªè */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* Buttons */
        .btn-group { display: grid; grid-template-columns: 1fr 2fr; gap: 12px; margin-top: 10px; }
        button { 
            padding: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 6px; 
            color: #fff; 
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-test { background: #21262d; color: var(--accent); border-color: var(--border-color); width: 100%; margin-top: 10px;}
        .btn-test:hover { background: #30363d; }

        .btn-reset { background: #21262d; color: var(--danger-color); border-color: var(--border-color); }
        .btn-reset:hover { background: rgba(218, 54, 51, 0.15); border-color: var(--danger-color); }

        .btn-save { background: var(--primary-color); border: none; }
        .btn-save:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-save:active { transform: translateY(0); }

        /* Terminal / Log */
        .terminal-window {
            background: #000;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            height: 250px;
            overflow-y: auto;
            color: #00ff00;
            position: relative;
        }
        .terminal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;
        }
        .status-log {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            border-left: 3px solid var(--text-muted);
        }

        /* Diagram Area */
        .diagram-container {
            background: #fff;
            border-radius: 6px;
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 180px;
        }
        .diagram-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 12px;
            line-height: 1.5;
            background: rgba(56, 139, 253, 0.1);
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid var(--info-color);
        }
        .highlight { color: var(--accent); font-weight: bold; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

    </style>
</head>
<body>

<div class="container">
    
    <div class="card">
        <div class="header-title">
            B·∫¢O MINH FACTORY <span class="version-badge">PRO V4.3</span>
        </div>

        <div class="form-group">
            <label>Token Xiaozhi (M√£ k·∫øt n·ªëi)</label>
            <input type="text" id="token" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
        </div>

        <div class="grid-2">
            <div class="form-group">
                <label>T√™n Thi·∫øt B·ªã (Ti·ªÅn t·ªë)</label>
                <input type="text" id="name" value="ƒê√®n">
            </div>
            <div class="form-group">
                <label>V·ªã Tr√≠ / Ph√≤ng</label>
                <input type="text" id="room" value="Ph√≤ng Kh√°ch">
            </div>
        </div>

        <div class="grid-2">
            <div class="form-group">
                <label>Lo·∫°i Chip</label>
                <select id="chip-type" onchange="updateDiagram()">
                    <option value="c3">ESP32-C3 Mini</option>
                    <option value="s3">ESP32-S3 Dev</option>
                    <option value="esp8266">ESP8266 (NodeMCU)</option>
                    <option value="esp32">ESP32 Standard</option>
                </select>
            </div>
            <div class="form-group">
                <label>S·ªë K√™nh Relay</label>
                <select id="ch">
                    <option value="1">1 K√™nh</option>
                    <option value="2">2 K√™nh</option>
                    <option value="4" selected>4 K√™nh</option>
                    <option value="8">8 K√™nh</option>
                </select>
            </div>
        </div>

        <button onclick="sendTest()" class="btn-test">
            üîä KI·ªÇM TRA K·∫æT N·ªêI (TEST SOUND)
        </button>

        <div class="btn-group">
            <button class="btn-reset" onclick="sendReset()" id="btnReset">
                üßπ FORMAT
            </button>
            <button class="btn-save" onclick="sendConfig()" id="btnSave">
                üíæ C·∫§U H√åNH & L∆ØU
            </button>
        </div>

        <div id="log" class="status-log">
            > Tr·∫°ng th√°i: Ch·ªù k·∫øt n·ªëi USB...
        </div>
    </div>

    <div class="card">
        
        <div>
            <label>S∆† ƒê·ªí ƒê·∫§U N·ªêI (WIRING DIAGRAM)</label>
            <div id="diagram-container" class="diagram-container">
                <div id="diagram-svg" style="width: 100%;"></div>
            </div>
            <div id="pin-desc" class="diagram-desc"></div>
        </div>

        <div style="flex-grow: 1; display: flex; flex-direction: column;">
            <div class="terminal-header">
                <span>SERIAL MONITOR</span>
                <button onclick="clearMonitor()" style="background:none; border:none; color:#666; padding:0; font-size:10px; width:auto;">CLEAR</button>
            </div>
            <div id="monitor" class="terminal-window">
                <div style="color:#555">Waiting for serial data...</div>
            </div>
            <div style="margin-top:5px; font-size:11px; color:#666; display:flex; align-items:center; gap:5px;">
                <input type="checkbox" id="autoscroll" checked style="width:auto; margin:0;"> 
                Auto-scroll
            </div>
        </div>
    </div>
</div>

<script>
    let port;
    let writer;
    
    function log(msg, color="#ccc") {
        const d = document.getElementById('log');
        // Update style based on message type
        if(color.includes("00ff00") || color === "green") d.style.borderLeftColor = "#238636";
        else if(color.includes("red")) d.style.borderLeftColor = "#da3633";
        else d.style.borderLeftColor = "#8b949e";
        
        d.innerHTML = `> ${msg}`;
    }

    function logMonitor(text) {
        const m = document.getElementById('monitor');
        // X√≥a d√≤ng waiting n·∫øu c√≥
        if(m.innerHTML.includes("Waiting for serial data...")) m.innerHTML = "";
        
        const formatted = text.replace(/\n/g, '<br>');
        m.innerHTML += formatted;
        
        if(document.getElementById('autoscroll').checked) {
            m.scrollTop = m.scrollHeight;
        }
    }

    function clearMonitor() {
        document.getElementById('monitor').innerHTML = "<div style='color:#555'>Waiting for serial data...</div>";
    }

    async function connect() {
        if (!port) {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                writer = port.writable.getWriter();
                log("ƒê√£ k·∫øt n·ªëi USB.", "#238636");
                readLoop();
                return true;
            } catch (err) {
                log("L·ªói k·∫øt n·ªëi: " + err, "#da3633");
                return false;
            }
        }
        return true;
    }

    async function readLoop() {
        const reader = port.readable.getReader();
        const decoder = new TextDecoder();
        try {
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const text = decoder.decode(value);
                
                logMonitor(text);

                if (text.includes("CONF_OK")) {
                    log("‚úÖ C·∫§U H√åNH TH√ÄNH C√îNG!", "#238636");
                    // alert("Th√†nh c√¥ng! Chip ƒë√£ nh·∫≠n c·∫•u h√¨nh.");
                }
                if (text.includes("TEST_OK")) {
                    log("‚úÖ K·∫æT N·ªêI T·ªêT (Test OK)", "#58a6ff");
                }
                if (text.includes("RESET_OK")) {
                    log("‚ö†Ô∏è ƒê√É FORMAT XONG. H√ÉY N·∫†P L·∫†I.", "#da3633");
                    alert("ƒê√£ x√≥a s·∫°ch. H√£y b·∫•m C·∫•u h√¨nh ngay.");
                }
            }
        } catch (error) {
            console.error(error);
        } finally {
            reader.releaseLock();
        }
    }

    async function sendTest() {
        if (!await connect()) return;
        log("ƒêang g·ª≠i l·ªánh Test...", "#fff");
        await writer.write(new TextEncoder().encode("CMD:TEST\n"));
    }

    async function sendReset() {
        if (!await connect()) return;
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA S·∫†CH chip?")) return;
        log("ƒêang g·ª≠i l·ªánh Format...", "#da3633");
        await writer.write(new TextEncoder().encode("CMD:RESET\n"));
    }

    async function sendConfig() {
        const token = document.getElementById('token').value.trim();
        const name = document.getElementById('name').value.trim();
        const room = document.getElementById('room').value.trim();
        const ch = document.getElementById('ch').value;

        if (!token) {
             alert("Vui l√≤ng nh·∫≠p Token!");
             document.getElementById('token').focus();
             return;
        }
        if (!await connect()) return;

        const cmd = `SET_CONFIG:${token},${name},${room},${ch}\n`;
        log("ƒêang n·∫°p c·∫•u h√¨nh...", "#fff");
        await writer.write(new TextEncoder().encode(cmd));
    }

    const diagrams = {
        c3: {
            svg: `<svg viewBox="0 0 200 120" style="width:100%"><rect x="10" y="10" width="60" height="80" fill="#333" rx="4"/><text x="40" y="55" fill="#fff" font-size="10" text-anchor="middle">ESP32-C3</text><rect x="130" y="10" width="60" height="80" fill="#2980b9" rx="4"/><text x="160" y="55" fill="#fff" font-size="10" text-anchor="middle">RELAY</text><line x1="70" y1="30" x2="130" y2="30" stroke="orange" stroke-width="2"/><text x="100" y="25" fill="#333" font-size="8" text-anchor="middle">GPIO</text><line x1="70" y1="70" x2="130" y2="70" stroke="black" stroke-width="2"/><text x="100" y="65" fill="#333" font-size="8" text-anchor="middle">GND</text></svg>`,
            desc: "<span class='highlight'>CH1-CH4:</span> GPIO 0, 1, 2, 3<br><span class='highlight'>CH5-CH8:</span> GPIO 4, 5, 6, 7<br><i>*Chip nh·ªè g·ªçn, r·∫•t th√¥ng d·ª•ng.</i>"
        },
        s3: {
            svg: `<svg viewBox="0 0 200 120" style="width:100%"><rect x="10" y="10" width="60" height="100" fill="#333" rx="4"/><text x="40" y="60" fill="#fff" font-size="10" text-anchor="middle">ESP32-S3</text><rect x="130" y="10" width="60" height="80" fill="#2980b9" rx="4"/><text x="160" y="55" fill="#fff" font-size="10" text-anchor="middle">RELAY</text><line x1="70" y1="30" x2="130" y2="30" stroke="orange" stroke-width="2"/><text x="100" y="25" fill="#333" font-size="8" text-anchor="middle">GPIO</text><line x1="70" y1="70" x2="130" y2="70" stroke="black" stroke-width="2"/><text x="100" y="65" fill="#333" font-size="8" text-anchor="middle">GND</text></svg>`,
            desc: "<span class='highlight'>CH1-CH4:</span> GPIO 4, 5, 6, 7<br><span class='highlight'>CH5-CH8:</span> GPIO 15, 16, 17, 18<br><i>*D√≤ng chip m·∫°nh m·∫Ω cho AI.</i>"
        },
        esp8266: {
            svg: `<svg viewBox="0 0 200 120" style="width:100%"><rect x="10" y="10" width="60" height="100" fill="#333" rx="4"/><text x="40" y="60" fill="#fff" font-size="10" text-anchor="middle">NodeMCU</text><rect x="130" y="10" width="60" height="80" fill="#2980b9" rx="4"/><text x="160" y="55" fill="#fff" font-size="10" text-anchor="middle">RELAY</text><line x1="70" y1="30" x2="130" y2="30" stroke="orange" stroke-width="2"/><text x="100" y="25" fill="#333" font-size="8" text-anchor="middle">D1/D2...</text><line x1="70" y1="70" x2="130" y2="70" stroke="black" stroke-width="2"/><text x="100" y="65" fill="#333" font-size="8" text-anchor="middle">GND</text></svg>`,
            desc: "<span class='highlight'>CH1-CH4:</span> D1, D2, D5, D6<br><span class='highlight'>CH5-CH8:</span> D7, D0, D3, D4<br><i>*Chip gi√° r·∫ª, ch√¢n D c√≥ th·ªÉ kh√°c in tr√™n board.</i>"
        },
        esp32: {
            svg: `<svg viewBox="0 0 200 120" style="width:100%"><rect x="10" y="10" width="60" height="100" fill="#333" rx="4"/><text x="40" y="60" fill="#fff" font-size="10" text-anchor="middle">ESP32</text><rect x="130" y="10" width="60" height="80" fill="#2980b9" rx="4"/><text x="160" y="55" fill="#fff" font-size="10" text-anchor="middle">RELAY</text><line x1="70" y1="30" x2="130" y2="30" stroke="orange" stroke-width="2"/><text x="100" y="25" fill="#333" font-size="8" text-anchor="middle">G13/G12...</text><line x1="70" y1="70" x2="130" y2="70" stroke="black" stroke-width="2"/><text x="100" y="65" fill="#333" font-size="8" text-anchor="middle">GND</text></svg>`,
            desc: "<span class='highlight'>CH1-CH4:</span> G13, G12, G14, G27<br><span class='highlight'>CH5-CH8:</span> G26, G25, G33, G32<br><i>*B·∫£n ti√™u chu·∫©n 30/38 ch√¢n.</i>"
        }
    };

    function updateDiagram() {
        const type = document.getElementById('chip-type').value;
        const data = diagrams[type];
        document.getElementById('diagram-svg').innerHTML = data.svg;
        document.getElementById('pin-desc').innerHTML = data.desc;
    }

    updateDiagram();
</script>
</body>
</html>
