<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£o Minh Setup Tool V4.0</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a0a; color: #fff; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .box { background: #1a1a1a; padding: 30px; border-radius: 12px; width: 100%; max-width: 450px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { color: #00e676; text-align: center; margin-top: 0; }
        label { font-size: 13px; color: #aaa; margin-top: 15px; display: block; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; margin-top: 25px; }
        button { flex: 1; padding: 15px; font-weight: bold; cursor: pointer; border: none; border-radius: 8px; transition: 0.2s; }
        .btn-save { background: #00e676; color: #000; }
        .btn-save:hover { background: #00c853; }
        .btn-reset { background: #e74c3c; color: #fff; }
        .btn-reset:hover { background: #c0392b; }
        #log { margin-top: 20px; font-family: monospace; font-size: 12px; color: #888; white-space: pre-wrap; height: 120px; overflow-y: auto; background: #111; padding: 10px; border-radius: 5px; border: 1px solid #333; }
    </style>
</head>
<body>

<div class="box">
    <h2>B·∫¢O MINH SETUP PRO</h2>
    <div style="text-align:center; color:#555; font-size:11px; margin-bottom:15px;">Phi√™n b·∫£n V9.6 - Sync Fix</div>

    <label>Token Xiaozhi:</label>
    <input type="text" id="token" placeholder="D√°n m√£ Token (ey...)">
    
    <div style="display: flex; gap: 10px;">
        <div style="flex:1">
            <label>T√™n G·ªëc:</label>
            <input type="text" id="name" value="ƒê√®n">
        </div>
        <div style="flex:1">
            <label>V·ªã Tr√≠:</label>
            <input type="text" id="room" value="Ph√≤ng Kh√°ch">
        </div>
    </div>

    <label>S·ªë K√™nh:</label>
    <select id="ch">
        <option value="1">1 K√™nh</option>
        <option value="2">2 K√™nh</option>
        <option value="4" selected>4 K√™nh</option>
        <option value="8">8 K√™nh</option>
    </select>

    <div class="btn-group">
        <button class="btn-reset" onclick="sendReset()" id="btnReset">üßπ FORMAT CHIP</button>
        <button class="btn-save" onclick="sendConfig()" id="btnSave">üíæ C·∫§U H√åNH & L∆ØU</button>
    </div>
    
    <div id="log">Ch∆∞a k·∫øt n·ªëi USB...</div>
</div>

<script>
    let port;
    let writer;
    
    function log(msg, color="#ccc") {
        const d = document.getElementById('log');
        d.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
        d.scrollTop = d.scrollHeight;
    }

    async function connect() {
        if (!port) {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                writer = port.writable.getWriter();
                log("ƒê√£ k·∫øt n·ªëi USB.", "#00e676");
                return true;
            } catch (err) {
                log("L·ªói k·∫øt n·ªëi: " + err, "red");
                return false;
            }
        }
        return true;
    }

    async function sendReset() {
        if (!await connect()) return;
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫°ch to√†n b·ªô d·ªØ li·ªáu trong Chip?")) return;
        
        log("ƒêang g·ª≠i l·ªánh RESET...", "orange");
        await writer.write(new TextEncoder().encode("CMD:RESET\n"));
        log("ƒê√£ g·ª≠i l·ªánh. ƒê·ª£i chip ph·∫£n h·ªìi...", "#fff");
        alert("ƒê√£ g·ª≠i l·ªánh Reset! H√£y ƒë·ª£i 3 gi√¢y r·ªìi n·∫°p c·∫•u h√¨nh m·ªõi.");
    }

    async function sendConfig() {
        const token = document.getElementById('token').value.trim();
        const name = document.getElementById('name').value.trim();
        const room = document.getElementById('room').value.trim();
        const ch = document.getElementById('ch').value;

        if (!token) return alert("Thi·∫øu Token!");
        if (!await connect()) return;

        const cmd = `SET_CONFIG:${token},${name},${room},${ch}\n`;
        log("ƒêang g·ª≠i c·∫•u h√¨nh...", "#fff");
        await writer.write(new TextEncoder().encode(cmd));
        
        log("‚úÖ ƒê√£ g·ª≠i xong! R√∫t chip ra ƒë∆∞·ª£c r·ªìi.", "#00ff00");
    }
</script>
</body>
</html>
