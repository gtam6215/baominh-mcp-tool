<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Bao Minh Setup</title>
    <style>
        body { font-family: sans-serif; background: #111; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .box { background: #1f1f1f; padding: 30px; border-radius: 15px; width: 400px; border: 1px solid #333; }
        input, select { width: 100%; padding: 12px; margin: 5px 0 15px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; box-sizing: border-box; }
        button { background: #0f0; width: 100%; padding: 15px; font-weight: bold; cursor: pointer; border: none; border-radius: 8px; }
        #log { margin-top: 15px; color: #0f0; font-size: 13px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="box">
        <h2 style="color:#0f0; text-align:center">CẤU HÌNH THIẾT BỊ</h2>
        <label>Token Xiaozhi:</label>
        <input type="text" id="token" placeholder="Dán Token...">
        
        <label>Tên Thiết Bị:</label>
        <input type="text" id="name" placeholder="Ví dụ: CongTac">
        
        <label>Khu Vực:</label>
        <select id="room">
            <option value="PhongKhach">Phòng Khách</option>
            <option value="PhongNgu">Phòng Ngủ</option>
            <option value="Bep">Bếp</option>
        </select>
        
        <button onclick="run()">ĐỒNG BỘ NGAY</button>
        <div id="log"></div>
    </div>

    <script>
        function log(m) { document.getElementById('log').innerText = m; }
        async function run() {
            const t = document.getElementById('token').value;
            const n = document.getElementById('name').value;
            const r = document.getElementById('room').value;
            if(!t) return alert("Nhập Token!");

            try {
                log("1. Đang kết nối Cloud...");
                await regCloud(t, n, r);
                
                log("2. Đang ghi vào Chip (Nếu lỗi hãy rút cáp cắm lại)...");
                const p = await navigator.serial.requestPort();
                await p.open({baudRate: 115200});
                const w = p.writable.getWriter();
                await w.write(new TextEncoder().encode(`SET_CONFIG:${t},${n},${r}\n`));
                w.releaseLock(); await p.close();
                
                log("✅ XONG! Thiết bị đang khởi động lại.");
                alert("Thành công! Hãy kết nối WiFi cho thiết bị.");
            } catch(e) { log("Lỗi: " + e.message + "\n(Hãy thử rút cáp USB và cắm lại)"); }
        }

        function regCloud(t, d, r) {
            return new Promise((resolve, reject) => {
                const ws = new WebSocket(`wss://api.xiaozhi.me/mcp/?token=${t}`);
                ws.onmessage = (e) => {
                    const j = JSON.parse(e.data);
                    if(j.method=="initialize") ws.send(JSON.stringify({jsonrpc:"2.0",id:j.id,result:{protocolVersion:"2024-11-05",serverInfo:{name:`[${r}] ${d}`,version:"1.0"}}}));
                    if(j.method=="tools/list") {
                        ws.send(JSON.stringify({jsonrpc:"2.0",id:j.id,result:{tools:[{name:"control_relay",description:`Dieu khien tai ${r}`,inputSchema:{type:"object",properties:{id:{type:"integer"},on:{type:"boolean"}}}}]}}));
                        setTimeout(()=>{ws.close();resolve()},1000);
                    }
                };
                ws.onerror=()=>reject(new Error("Token lỗi"));
                setTimeout(()=>reject(new Error("Timeout")),5000);
            });
        }
    </script>
</body>
</html>
