<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Bao Minh Setup</title>
    <style>
        body { font-family: sans-serif; background: #111; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .box { background: #1f1f1f; padding: 30px; border-radius: 15px; width: 400px; border: 1px solid #333; }
        input, select { width: 100%; padding: 12px; margin: 5px 0 15px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; box-sizing: border-box; }
        button { background: #0f0; width: 100%; padding: 15px; font-weight: bold; cursor: pointer; border: none; border-radius: 8px; font-size: 15px; }
        button:hover { background: #00cc00; }
        #log { margin-top: 15px; color: #0f0; font-size: 13px; white-space: pre-wrap; line-height: 1.5; background: #000; padding: 10px; border-radius: 5px; display: none; }
        .error { color: #ff4444 !important; }
    </style>
</head>
<body>
    <div class="box">
        <h2 style="color:#0f0; text-align:center">C·∫§U H√åNH THI·∫æT B·ªä</h2>
        
        <label style="font-size:12px; color:#aaa">Token Xiaozhi (D√°n link wss:// tho·∫£i m√°i):</label>
        <input type="text" id="token" placeholder="D√°n Token v√†o ƒë√¢y...">
        
        <label style="font-size:12px; color:#aaa">T√™n Thi·∫øt B·ªã:</label>
        <input type="text" id="name" placeholder="V√≠ d·ª•: CongTac">
        
        <label style="font-size:12px; color:#aaa">Khu V·ª±c:</label>
        <select id="room">
            <option value="PhongKhach">Ph√≤ng Kh√°ch</option>
            <option value="PhongNgu">Ph√≤ng Ng·ªß</option>
            <option value="Bep">B·∫øp</option>
            <option value="SanVuon">S√¢n V∆∞·ªùn</option>
        </select>
        
        <button onclick="run()">CH·ªåN C·ªîNG USB & ƒê·ªíNG B·ªò</button>
        <div id="log"></div>
    </div>

    <script>
        function log(m, isErr=false) { 
            const el = document.getElementById('log');
            el.style.display = 'block';
            el.innerHTML += `<div class="${isErr?'error':''}">${m}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        function extractToken(input) {
            input = input.trim();
            if (input.includes("token=")) return input.split("token=")[1];
            return input;
        }

        async function run() {
            // X√≥a log c≈©
            document.getElementById('log').innerHTML = "";
            
            let rawInput = document.getElementById('token').value;
            const token = extractToken(rawInput);
            const n = document.getElementById('name').value.trim() || "ThietBi";
            const r = document.getElementById('room').value;

            if(!token) return alert("Vui l√≤ng nh·∫≠p Token!");

            let port;
            try {
                // B∆Ø·ªöC 1: Y√äU C·∫¶U C·ªîNG USB NGAY L·∫¨P T·ª®C (Tr√°nh b·ªã tr√¨nh duy·ªát ch·∫∑n)
                // M·ªôt c·ª≠a s·ªï popup s·∫Ω hi·ªán ra ·ªü g√≥c tr√™n b√™n tr√°i
                port = await navigator.serial.requestPort();
                log("‚úÖ ƒê√£ ch·ªçn c·ªïng USB.");
            } catch (e) {
                return log("‚ùå B·∫°n ch∆∞a ch·ªçn c·ªïng USB ho·∫∑c ƒë√£ h·ªßy b·ªè.", true);
            }

            try {
                // B∆Ø·ªöC 2: K·∫æT N·ªêI CLOUD (Ch·∫°y ng·∫ßm)
                log("‚è≥ ƒêang ƒëƒÉng k√Ω Cloud Xiaozhi...");
                await regCloud(token, n, r);
                log("‚úÖ ƒêƒÉng k√Ω Cloud th√†nh c√¥ng!");

                // B∆Ø·ªöC 3: GHI V√ÄO CHIP
                log("‚è≥ ƒêang ghi c·∫•u h√¨nh v√†o Chip...");
                await port.open({baudRate: 115200});
                const w = p = port.writable.getWriter();
                
                await w.write(new TextEncoder().encode(`SET_CONFIG:${token},${n},${r}\n`));
                
                w.releaseLock(); 
                await port.close();
                
                log("üéâ XONG! Thi·∫øt b·ªã ƒëang kh·ªüi ƒë·ªông l·∫°i.");
                alert("C√†i ƒë·∫∑t ho√†n t·∫•t!");
            } catch(e) { 
                console.error(e);
                log("‚ùå L·ªói: " + e.message, true); 
            }
        }

        function regCloud(t, d, r) {
            return new Promise((resolve, reject) => {
                const ws = new WebSocket(`wss://api.xiaozhi.me/mcp/?token=${t}`);
                
                ws.onmessage = (e) => {
                    try {
                        const j = JSON.parse(e.data);
                        if(j.method=="initialize") {
                            ws.send(JSON.stringify({
                                jsonrpc:"2.0", id:j.id,
                                result:{
                                    protocolVersion:"2024-11-05",
                                    serverInfo:{name:`[${r}] ${d}`, version:"1.0"}
                                }
                            }));
                        }
                        if(j.method=="tools/list") {
                            ws.send(JSON.stringify({
                                jsonrpc:"2.0", id:j.id,
                                result:{
                                    tools:[{
                                        name:"control_relay",
                                        description:`Dieu khien tai ${r}`,
                                        inputSchema:{type:"object", properties:{id:{type:"integer"}, on:{type:"boolean"}}}
                                    }]
                                }
                            }));
                            setTimeout(()=>{ ws.close(); resolve(); }, 1000);
                        }
                    } catch(err) {}
                };
                
                ws.onerror = () => reject(new Error("L·ªói k·∫øt n·ªëi Xiaozhi (Ki·ªÉm tra Token)"));
                setTimeout(()=>reject(new Error("Server Xiaozhi ph·∫£n h·ªìi qu√° l√¢u")), 8000);
            });
        }
    </script>
</body>
</html>
