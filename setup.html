<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bao Minh Setup Assistant</title>
    <style>
        body { font-family: sans-serif; background: #111; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .box { background: #1f1f1f; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; border: 1px solid #333; }
        h2 { color: #00ff88; text-align: center; margin-top: 0; }
        label { font-size: 12px; color: #aaa; margin-top: 10px; display: block; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 5px; box-sizing: border-box; }
        .btn { background: #00ff88; color: black; width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 16px; }
        .btn:hover { background: #00cc6a; }
        #log { margin-top: 15px; font-size: 12px; text-align: center; color: #00ff88; min-height: 20px; }
    </style>
</head>
<body>
    <div class="box">
        <h2>C·∫§U H√åNH THI·∫æT B·ªä</h2>
        
        <label>Xiaozhi Token (MCP)</label>
        <input type="text" id="token" placeholder="D√°n Token d√†i v√†o ƒë√¢y...">

        <label>T√™n Thi·∫øt B·ªã</label>
        <input type="text" id="name" placeholder="V√≠ d·ª•: DenChum">

        <label>Khu V·ª±c / Ph√≤ng</label>
        <select id="room">
            <option value="PhongKhach">Ph√≤ng Kh√°ch</option>
            <option value="PhongNgu">Ph√≤ng Ng·ªß</option>
            <option value="NhaBep">Nh√† B·∫øp</option>
            <option value="SanVuon">S√¢n V∆∞·ªùn</option>
        </select>

        <button class="btn" onclick="runProcess()">ƒê·ªíNG B·ªò & K√çCH HO·∫†T</button>
        <div id="log"></div>
    </div>

    <script>
        async function runProcess() {
            const token = document.getElementById('token').value.trim();
            const name = document.getElementById('name').value.trim() || "ThietBi";
            const room = document.getElementById('room').value;
            const log = document.getElementById('log');

            if (!token) { alert("Ch∆∞a nh·∫≠p Token!"); return; }

            try {
                // B∆Ø·ªöC 1: ƒêƒÇNG K√ù L√äN CLOUD (T·∫°o Endpoint)
                log.innerText = "‚òÅÔ∏è ƒêang ƒëƒÉng k√Ω Endpoint l√™n Xiaozhi...";
                await registerToCloud(token, name, room);

                // B∆Ø·ªöC 2: G·ª¨I V√ÄO CHIP QUA USB
                log.innerText = "üîå ƒêang ghi v√†o Chip...";
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                const writer = port.writable.getWriter();
                
                // G·ª≠i ƒë·ªãnh d·∫°ng: SET_CONFIG:token,name,room
                const data = `SET_CONFIG:${token},${name},${room}\n`;
                await writer.write(new TextEncoder().encode(data));
                
                writer.releaseLock();
                await port.close();

                log.innerHTML = "‚úÖ TH√ÄNH C√îNG!<br>Thi·∫øt b·ªã ƒëang kh·ªüi ƒë·ªông l·∫°i.";
            } catch (err) {
                log.innerText = "‚ùå L·ªói: " + err.message;
            }
        }

        // Logic gi·∫£ l·∫≠p thi·∫øt b·ªã ƒë·ªÉ t·∫°o Endpoint tr√™n Cloud
        function registerToCloud(token, dName, rName) {
            return new Promise((resolve, reject) => {
                const ws = new WebSocket(`wss://api.xiaozhi.me/mcp/?token=${token}`);
                ws.onmessage = (e) => {
                    const d = JSON.parse(e.data);
                    // Ph·∫£n h·ªìi Initialize
                    if (d.method === "initialize") {
                        ws.send(JSON.stringify({
                            "jsonrpc": "2.0", "id": d.id,
                            "result": { "protocolVersion": "2024-11-05", "serverInfo": { "name": `[${rName}] ${dName}`, "version": "1.0.0" } }
                        }));
                    }
                    // ƒêƒÉng k√Ω Tool (Endpoint)
                    if (d.method === "tools/list") {
                        ws.send(JSON.stringify({
                            "jsonrpc": "2.0", "id": d.id,
                            "result": { "tools": [{ "name": "control_relay", "description": `ƒêi·ªÅu khi·ªÉn t·∫°i ${rName}`, "inputSchema": { "type": "object", "properties": { "id": {"type":"integer"}, "on": {"type":"boolean"} } } }] }
                        }));
                        setTimeout(() => { ws.close(); resolve(); }, 1500); // ƒê·ª£i server x√°c nh·∫≠n r·ªìi ƒë√≥ng
                    }
                };
                ws.onerror = () => reject(new Error("L·ªói k·∫øt n·ªëi Token!"));
                setTimeout(() => reject(new Error("Timeout Cloud")), 8000);
            });
        }
    </script>
</body>
</html>
