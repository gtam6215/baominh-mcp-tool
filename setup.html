<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£o Minh Setup Tool V4.2 - Pro Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a0a; color: #fff; margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; box-sizing: border-box;}
        
        /* Layout Grid */
        .container { display: flex; gap: 20px; width: 100%; max-width: 1200px; flex-wrap: wrap; align-items: flex-start; }
        .col { flex: 1; min-width: 350px; display: flex; flex-direction: column; gap: 20px; }

        /* Box Styles */
        .box { background: #1a1a1a; padding: 25px; border-radius: 12px; border: 1px solid #333; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        h2, h3 { color: #00e676; margin: 0; font-size: 1.2rem; }
        
        /* Form Elements */
        label { font-size: 13px; color: #aaa; margin-top: 10px; display: block; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; }
        input:focus, select:focus { border-color: #00e676; outline: none; }

        /* Buttons */
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 12px; font-weight: bold; cursor: pointer; border: none; border-radius: 6px; transition: 0.2s; color: #fff; }
        .btn-save { background: #00e676; color: #000; } .btn-save:hover { background: #00c853; }
        .btn-reset { background: #e74c3c; } .btn-reset:hover { background: #c0392b; }
        .btn-test { background: #3498db; margin-top: 15px; width: 100%; } .btn-test:hover { background: #2980b9; }
        .btn-clear { background: #555; padding: 5px 10px; font-size: 12px; width: auto; flex: none; }

        /* Log & Monitor */
        .log-box { font-family: 'Consolas', monospace; font-size: 12px; color: #ccc; background: #000; padding: 10px; border-radius: 5px; border: 1px solid #333; overflow-y: auto; }
        #log { height: 80px; white-space: pre-wrap; }
        #monitor { height: 300px; color: #00ff00; }

        /* Diagram */
        #diagram-svg { width: 100%; height: auto; background: #fff; border-radius: 8px; padding: 10px; box-sizing: border-box; }
        .pin-desc { font-size: 12px; color: #aaa; margin-top: 10px; line-height: 1.4; }
        .highlight { color: #00e676; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="col">
        <div class="box">
            <div class="box-header">
                <h2>C·∫§U H√åNH THI·∫æT B·ªä</h2>
                <span style="font-size:11px; color:#666">V4.2</span>
            </div>

            <label>Token Xiaozhi:</label>
            <input type="text" id="token" placeholder="D√°n m√£ Token (ey...)">
            
            <div style="display: flex; gap: 10px;">
                <div style="flex:1">
                    <label>T√™n G·ªëc:</label>
                    <input type="text" id="name" value="ƒê√®n">
                </div>
                <div style="flex:1">
                    <label>V·ªã Tr√≠:</label>
                    <input type="text" id="room" value="Ph√≤ng Kh√°ch">
                </div>
            </div>

            <label>S·ªë K√™nh:</label>
            <select id="ch">
                <option value="1">1 K√™nh</option>
                <option value="2">2 K√™nh</option>
                <option value="4" selected>4 K√™nh</option>
                <option value="8">8 K√™nh</option>
            </select>

            <button onclick="sendTest()" class="btn-test">üîä TEST K·∫æT N·ªêI (K√äU T·∫†CH)</button>

            <div class="btn-group">
                <button class="btn-reset" onclick="sendReset()" id="btnReset">üßπ FORMAT</button>
                <button class="btn-save" onclick="sendConfig()" id="btnSave">üíæ C·∫§U H√åNH</button>
            </div>
            
            <label>Tr·∫°ng th√°i:</label>
            <div id="log" class="log-box">Ch∆∞a k·∫øt n·ªëi USB...</div>
        </div>
    </div>

    <div class="col">
        <div class="box">
            <div class="box-header">
                <h3>S∆† ƒê·ªí ƒê·∫§U N·ªêI</h3>
                <select id="chip-type" onchange="updateDiagram()" style="width: 150px; margin:0; padding:5px;">
                    <option value="c3">ESP32-C3 Mini</option>
                    <option value="s3">ESP32-S3 Dev</option>
                    <option value="esp8266">ESP8266 (NodeMCU)</option>
                    <option value="esp32">ESP32 Standard</option>
                </select>
            </div>
            <div id="diagram-container">
                <div id="diagram-svg"></div>
            </div>
            <div id="pin-desc" class="pin-desc"></div>
        </div>

        <div class="box">
            <div class="box-header">
                <h3>SERIAL MONITOR</h3>
                <button class="btn-clear" onclick="clearMonitor()">X√≥a</button>
            </div>
            <div id="monitor" class="log-box"></div>
            <div style="margin-top:5px; font-size:11px; color:#666">
                <input type="checkbox" id="autoscroll" checked style="width:auto; margin:0; vertical-align:middle"> 
                T·ª± ƒë·ªông cu·ªôn xu·ªëng
            </div>
        </div>
    </div>
</div>

<script>
    // --- PH·∫¶N LOGIC C≈® (GI·ªÆ NGUY√äN) ---
    let port;
    let writer;
    
    function log(msg, color="#ccc") {
        const d = document.getElementById('log');
        d.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
        d.scrollTop = d.scrollHeight;
    }

    // H√†m Monitor m·ªõi
    function logMonitor(text) {
        const m = document.getElementById('monitor');
        // Thay th·∫ø k√Ω t·ª± xu·ªëng d√≤ng ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp
        const formatted = text.replace(/\n/g, '<br>');
        m.innerHTML += formatted;
        
        if(document.getElementById('autoscroll').checked) {
            m.scrollTop = m.scrollHeight;
        }
    }

    function clearMonitor() {
        document.getElementById('monitor').innerHTML = "";
    }

    async function connect() {
        if (!port) {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                writer = port.writable.getWriter();
                log("ƒê√£ k·∫øt n·ªëi USB.", "#00e676");
                // ƒê·ªçc ph·∫£n h·ªìi
                readLoop();
                return true;
            } catch (err) {
                log("L·ªói k·∫øt n·ªëi: " + err, "red");
                return false;
            }
        }
        return true;
    }

    async function readLoop() {
        const reader = port.readable.getReader();
        const decoder = new TextDecoder();
        try {
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const text = decoder.decode(value);
                
                // ƒê·∫©y d·ªØ li·ªáu th√¥ v√†o Monitor
                logMonitor(text);

                // Logic ph√¢n t√≠ch ph·∫£n h·ªìi c≈©
                if (text.includes("CONF_OK")) {
                    log("‚úÖ TH√ÄNH C√îNG! (Chip ƒë√£ l∆∞u)", "#00ff00");
                    alert("C·∫•u h√¨nh th√†nh c√¥ng! Nghe ti·∫øng t·∫°ch d√†i l√† OK.");
                }
                if (text.includes("TEST_OK")) {
                    log("‚úÖ K·∫æT N·ªêI T·ªêT!", "#3498db");
                }
                if (text.includes("RESET_OK")) {
                    log("‚úÖ ƒê√É FORMAT XONG!", "orange");
                    alert("ƒê√£ x√≥a s·∫°ch chip. Gi·ªù h√£y n·∫°p c·∫•u h√¨nh.");
                }
            }
        } catch (error) {
            console.error(error);
            log("L·ªói ƒë·ªçc: " + error, "red");
        } finally {
            reader.releaseLock();
        }
    }

    async function sendTest() {
        if (!await connect()) return;
        log("G·ª≠i l·ªánh Test...", "#fff");
        await writer.write(new TextEncoder().encode("CMD:TEST\n"));
    }

    async function sendReset() {
        if (!await connect()) return;
        if (!confirm("X√≥a s·∫°ch chip?")) return;
        log("G·ª≠i l·ªánh Format...", "orange");
        await writer.write(new TextEncoder().encode("CMD:RESET\n"));
    }

    async function sendConfig() {
        const token = document.getElementById('token').value.trim();
        const name = document.getElementById('name').value.trim();
        const room = document.getElementById('room').value.trim();
        const ch = document.getElementById('ch').value;

        if (!token) return alert("Thi·∫øu Token!");
        if (!await connect()) return;

        const cmd = `SET_CONFIG:${token},${name},${room},${ch}\n`;
        log("ƒêang g·ª≠i c·∫•u h√¨nh...", "#fff");
        await writer.write(new TextEncoder().encode(cmd));
    }

    // --- PH·∫¶N LOGIC M·ªöI: V·∫º S∆† ƒê·ªí ---
    const diagrams = {
        c3: {
            svg: `<svg viewBox="0 0 200 120" style="width:100%"><rect x="10" y="10" width="60" height="80" fill="#333" rx="4"/><text x="40" y="55" fill="#fff" font-size="10" text-anchor="middle">ESP32-C3</text><rect x="130" y="10" width="60" height="80" fill="#2980b9" rx="4"/><text x="160" y="55" fill="#fff" font-size="10" text-anchor="middle">RELAY</text><line x1="70" y1="30" x2="130" y2="30" stroke="orange" stroke-width="2"/><text x="100" y="25" fill="#333" font-size="8" text-anchor="middle">GPIO</text><line x1="70" y1="70" x2="130" y2="70" stroke="black" stroke-width="2"/><text x="100" y="65" fill="#333" font-size="8" text-anchor="middle">GND</text></svg>`,
            desc: "<span class='highlight'>CH1-CH4:</span> GPIO 0, 1, 2, 3<br><span class='highlight'>CH5-CH8:</span> GPIO 4, 5, 6, 7<br><i>*Chip nh·ªè g·ªçn, r·∫•t th√¥ng d·ª•ng.</i>"
        },
        s3: {
            svg: `<svg viewBox="0 0 200 120" style="width:100%"><rect x="10" y="10" width="60" height="100" fill="#333" rx="4"/><text x="40" y="60" fill="#fff" font-size="10" text-anchor="middle">ESP32-S3</text><rect x="130" y="10" width="60" height="80" fill="#2980b9" rx="4"/><text x="160" y="55" fill="#fff" font-size="10" text-anchor="middle">RELAY</text><line x1="70" y1="30" x2="130" y2="30" stroke="orange" stroke-width="2"/><text x="100" y="25" fill="#333" font-size="8" text-anchor="middle">GPIO</text><line x1="70" y1="70" x2="130" y2="70" stroke="black" stroke-width="2"/><text x="100" y="65" fill="#333" font-size="8" text-anchor="middle">GND</text></svg>`,
            desc: "<span class='highlight'>CH1-CH4:</span> GPIO 4, 5, 6, 7<br><span class='highlight'>CH5-CH8:</span> GPIO 15, 16, 17, 18<br><i>*D√≤ng chip m·∫°nh m·∫Ω cho AI.</i>"
        },
        esp8266: {
            svg: `<svg viewBox="0 0 200 120" style="width:100%"><rect x="10" y="10" width="60" height="100" fill="#333" rx="4"/><text x="40" y="60" fill="#fff" font-size="10" text-anchor="middle">NodeMCU</text><rect x="130" y="10" width="60" height="80" fill="#2980b9" rx="4"/><text x="160" y="55" fill="#fff" font-size="10" text-anchor="middle">RELAY</text><line x1="70" y1="30" x2="130" y2="30" stroke="orange" stroke-width="2"/><text x="100" y="25" fill="#333" font-size="8" text-anchor="middle">D1/D2...</text><line x1="70" y1="70" x2="130" y2="70" stroke="black" stroke-width="2"/><text x="100" y="65" fill="#333" font-size="8" text-anchor="middle">GND</text></svg>`,
            desc: "<span class='highlight'>CH1-CH4:</span> D1, D2, D5, D6<br><span class='highlight'>CH5-CH8:</span> D7, D0, D3, D4<br><i>*Chip gi√° r·∫ª, ch√¢n D c√≥ th·ªÉ kh√°c in tr√™n board.</i>"
        },
        esp32: {
            svg: `<svg viewBox="0 0 200 120" style="width:100%"><rect x="10" y="10" width="60" height="100" fill="#333" rx="4"/><text x="40" y="60" fill="#fff" font-size="10" text-anchor="middle">ESP32</text><rect x="130" y="10" width="60" height="80" fill="#2980b9" rx="4"/><text x="160" y="55" fill="#fff" font-size="10" text-anchor="middle">RELAY</text><line x1="70" y1="30" x2="130" y2="30" stroke="orange" stroke-width="2"/><text x="100" y="25" fill="#333" font-size="8" text-anchor="middle">G13/G12...</text><line x1="70" y1="70" x2="130" y2="70" stroke="black" stroke-width="2"/><text x="100" y="65" fill="#333" font-size="8" text-anchor="middle">GND</text></svg>`,
            desc: "<span class='highlight'>CH1-CH4:</span> G13, G12, G14, G27<br><span class='highlight'>CH5-CH8:</span> G26, G25, G33, G32<br><i>*B·∫£n ti√™u chu·∫©n 30/38 ch√¢n.</i>"
        }
    };

    function updateDiagram() {
        const type = document.getElementById('chip-type').value;
        const data = diagrams[type];
        document.getElementById('diagram-svg').innerHTML = data.svg;
        document.getElementById('pin-desc').innerHTML = data.desc;
    }

    // Kh·ªüi t·∫°o s∆° ƒë·ªì m·∫∑c ƒë·ªãnh
    updateDiagram();
</script>
</body>
</html>
